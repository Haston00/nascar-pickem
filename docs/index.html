<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Big Dawg's Nascar Pickem 2025</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background-color: #f0f0f0; }
    h1 { color: #d40000; }
    table { border-collapse: collapse; width: 90%; margin: 20px auto; }
    th, td { border: 1px solid black; padding: 8px; }
    th { background-color: #333; color: white; }
    .winner { background-color: #90ee90; font-weight: bold; }
    .standings { width: 50%; margin: 20px auto; }
    .banner { 
      padding: 10px; 
      margin: 10px auto; 
      color: white; 
      font-weight: bold; 
      font-size: 18px; 
      border-radius: 5px; 
      width: 50%; 
    }
    .cubs-banner { 
      background-color: #0E3386; /* Cubs Blue */
      border: 2px solid #CC3433; /* Cubs Red */
    }
    .braves-banner { 
      background-color: #13274F; /* Braves Navy */
      border: 2px solid #CE1141; /* Braves Red */
    }
  </style>
</head>
<body>
  <h1>Big Dawg's Nascar Pickem 2025</h1>
  <div class="banner cubs-banner">Go Cubs Go!</div>
  <div class="banner braves-banner">Chop On!</div>
  <div id="login">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Log In</button>
  </div>
  <div id="pool" style="display:none;">
    <h2>Current Race: <span id="raceName">Loading...</span></h2>
    <table id="picksTable">
      <tr><th>Player</th><th>Driver</th><th>Finish</th><th>Winner</th></tr>
    </table>
    <h3>Season Standings</h3>
    <table id="standingsTable" class="standings">
      <tr><th>Player</th><th>Wins</th></tr>
    </table>
    <h3>Average Driver Finish</h3>
    <table id="averageTable" class="standings">
      <tr><th>Player</th><th>Average Finish</th></tr>
    </table>
    <h3>Season History</h3>
    <table id="historyTable">
      <tr>
        <th>Race</th>
        <th>Pop</th>
        <th>Finish</th>
        <th>Mom</th>
        <th>Finish</th>
        <th>Greg</th>
        <th>Finish</th>
        <th>Matty</th>
        <th>Finish</th>
        <th>Brandon</th>
        <th>Finish</th>
      </tr>
    </table>
  </div>

  <!-- Firebase SDK (compat versions) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script>
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDljeqAAW3mF5vlvR7NfaoHVja05j4kFT8",
      authDomain: "big-dawg-s-nascar.firebaseapp.com",
      projectId: "big-dawg-s-nascar",
      storageBucket: "big-dawg-s-nascar.firebasestorage.app",
      messagingSenderId: "432482855826",
      appId: "1:432482855826:web:1f1d961564da6d042daf4b",
      measurementId: "G-F07JSF8LJS"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function login() {
      console.log("Login function called");
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      console.log("Attempting to sign in with email:", email);
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          console.log("Login successful:", userCredential.user.email);
          document.getElementById("login").style.display = "none";
          document.getElementById("pool").style.display = "block";
          loadData();
        })
        .catch((error) => {
          console.error("Login failed:", error.code, error.message);
          alert("Login failed: " + error.message);
        });
    }

    function loadData() {
      // Current Race
      db.collection("races").doc("current").get().then((doc) => {
        if (doc.exists) {
          console.log("Current race data:", doc.data());
          const data = doc.data();
          document.getElementById("raceName").innerText = data.raceName || "Unknown Race";
          const table = document.getElementById("picksTable");
          // Clear existing rows (except header)
          while (table.rows.length > 1) {
            table.deleteRow(1);
          }
          if (data.picks && Array.isArray(data.picks)) {
            data.picks.forEach(pick => {
              const row = table.insertRow();
              row.insertCell().innerText = pick.player;
              row.insertCell().innerText = pick.driver;
              row.insertCell().innerText = pick.finish || "TBD";
              row.insertCell().innerText = pick.winner ? "Yes" : "No";
              if (pick.winner) row.className = "winner";
            });
          } else {
            console.error("Picks data is missing or not an array:", data.picks);
            document.getElementById("raceName").innerText = "Error: Picks data missing";
          }
        } else {
          console.error("Current race document does not exist");
          document.getElementById("raceName").innerText = "No current race available";
        }
      }).catch((error) => {
        console.error("Error fetching current race:", error);
        document.getElementById("raceName").innerText = "Error: Failed to load race";
      });

      // Standings
      db.collection("standings").orderBy("wins", "desc").get().then((query) => {
        const table = document.getElementById("standingsTable");
        // Clear existing rows (except header)
        while (table.rows.length > 1) {
          table.deleteRow(1);
        }
        query.forEach((doc) => {
          const data = doc.data();
          const row = table.insertRow();
          row.insertCell().innerText = doc.id;
          row.insertCell().innerText = data.wins;
        });
      });

      // Average Finishes
      db.collection("averages").get().then((query) => {
        const table = document.getElementById("averageTable");
        // Clear existing rows (except header)
        while (table.rows.length > 1) {
          table.deleteRow(1);
        }
        // Collect all players and their averages
        const players = [];
        query.forEach((doc) => {
          const data = doc.data();
          players.push({ player: doc.id, average: parseFloat(data.average) });
        });
        // Sort players by average finish (ascending: best to worst)
        players.sort((a, b) => a.average - b.average);
        // Add sorted players to the table
        players.forEach(player => {
          const row = table.insertRow();
          row.insertCell().innerText = player.player;
          row.insertCell().innerText = player.average.toFixed(2);
        });
      });

      // Season History
      db.collection("races").get().then((query) => {
        const table = document.getElementById("historyTable");
        // Clear existing rows (except header)
        while (table.rows.length > 1) {
          table.deleteRow(1);
        }
        query.forEach((doc) => {
          if (doc.id !== "current") {
            const data = doc.data();
            console.log("Race document:", doc.id, data); // Debug logging
            const raceName = data.raceName || doc.id; // Use raceName, fallback to doc.id
            const picks = data.picks;
            const row = table.insertRow();

            // Race name
            row.insertCell().innerText = raceName;

            // Initialize cells for each player (Pop, Mom, Greg, Matty, Brandon)
            const players = ["Pop", "Mom", "Greg", "Matty", "Brandon"];
            const playerPicks = {};
            players.forEach(player => {
              playerPicks[player] = { driver: "N/A", finish: "N/A", winner: false };
            });

            // Fill in picks for each player
            if (picks && Array.isArray(picks)) {
              picks.forEach(pick => {
                playerPicks[pick.player] = {
                  driver: pick.driver,
                  finish: pick.finish || "TBD",
                  winner: pick.winner || false
                };
              });
            } else {
              console.error("Picks data is missing or not an array for race:", doc.id, picks);
            }

            // Add cells for each player (driver, finish)
            players.forEach(player => {
              const pick = playerPicks[player];
              row.insertCell().innerText = pick.driver;
              const finishCell = row.insertCell();
              finishCell.innerText = pick.finish;
              if (pick.winner === true || pick.winner === "Yes") {
                finishCell.className = "winner";
              }
            });
          }
        });
      }).catch((error) => {
        console.error("Error fetching season history:", error);
      });
    }
  </script>
</body>
</html>
